<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nh·∫≠n Di·ªán M√≥n ƒÇn</title>

    <!-- Bootstrap & Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://aichat.ueh.edu.vn/keycloak/resources/q4rta/login/ueh/css/styles.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f4f7f9;
        font-family: "Segoe UI", sans-serif;
      }
      .container-custom {
        max-width: 1200px;
        margin: 40px auto;
        padding: 2rem;
        background: #fff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
      }

      .ueh-logo {
        height: 60px;
      }
      .camera-container {
        background-color: #e9ecef;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 360px;
      }
      video {
        border-radius: 10px;
        max-width: 100%;
        height: auto;
      }
      .captured-images img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin: 4px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .dish-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 1rem;
      }
      .total-price {
        font-weight: bold;
        font-size: 1.2rem;
        color: #0d6efd;
        text-align: right;
        margin-top: 10px;
      }
      .btn-reset {
        margin-top: 15px;
      }
    </style>
  </head>

  <body>
    <div class="container-custom">
      <div class="text-center mb-4">
        <img
          src="https://aichat.ueh.edu.vn/keycloak/resources/q4rta/login/ueh/img/ueh-logo.png"
          class="ueh-logo"
          alt="UEH Logo"
        />
        <h3 class="mt-3">NH·∫¨N DI·ªÜN M√ìN - THANH TO√ÅN T·ª®C TH√å</h3>
      </div>

      <div class="row">
        <!-- C·ªôt tr√°i: Camera & Upload -->
        <div class="col-md-5">
          <div class="camera-container">
            <video id="webcam" autoplay playsinline></video>
            <canvas id="captureCanvas" style="display: none"></canvas>
          </div>

          <div class="text-center mt-3">
            <button class="btn btn-primary mb-2" onclick="captureAndDetect()">
              üì∏ Ch·ª•p & Nh·∫≠n Di·ªán
            </button>
            <div class="form-text">Ho·∫∑c t·∫£i ·∫£nh t·ª´ m√°y:</div>
            <input
              type="file"
              class="form-control mt-2"
              accept="image/*"
              onchange="handleUpload(this)"
            />
          </div>

          <div class="form-text text-center mt-3">
            B·∫°n c√≥ th·ªÉ ch·ª•p ho·∫∑c upload nhi·ªÅu ·∫£nh ƒë·ªÉ ph√¢n t√≠ch m√≥n ƒÉn.
          </div>

          <div
            class="captured-images d-flex flex-wrap justify-content-center mt-3"
            id="captured-images"
          ></div>
        </div>

        <!-- C·ªôt ph·∫£i: Danh s√°ch m√≥n ƒÉn -->
        <div class="col-md-7">
          <h5>üßæ Danh s√°ch m√≥n ƒÉn:</h5>
          <div id="dish-items"></div>
          <div class="total-price" id="total-price">T·ªïng ti·ªÅn: 0‚Ç´</div>

          <div class="text-end">
            <button
              class="btn btn-outline-danger btn-reset"
              onclick="resetOrder()"
            >
              üóëÔ∏è Reset h√≥a ƒë∆°n
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const webcam = document.getElementById("webcam");
      const canvas = document.getElementById("captureCanvas");
      const context = canvas.getContext("2d");

      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => (webcam.srcObject = stream))
        .catch((err) => console.error("Webcam kh√¥ng ho·∫°t ƒë·ªông:", err));

      let allDishes = [];

      function captureAndDetect() {
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        context.drawImage(webcam, 0, 0);

        const imageDataURL = canvas.toDataURL("image/jpeg");
        showPreviewImage(imageDataURL);
        sendImageToServer(imageDataURL);
      }

      function handleUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const base64Image = e.target.result;
          showPreviewImage(base64Image);
          sendImageToServer(base64Image);
        };
        reader.readAsDataURL(file);
      }

      function showPreviewImage(base64Image) {
        const imgEl = document.createElement("img");
        imgEl.src = base64Image;
        document.getElementById("captured-images").appendChild(imgEl);
      }

      function sendImageToServer(base64Image) {
        fetch("/predict", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ image: base64Image }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              alert("L·ªói x·ª≠ l√Ω ·∫£nh: " + data.error);
              return;
            }

            if (data.dishes) {
              allDishes = allDishes.concat(data.dishes);
              renderDishList();
            } else {
              alert("Kh√¥ng ph√°t hi·ªán m√≥n ƒÉn n√†o.");
            }
          })
          .catch((err) => {
            console.error("L·ªói g·ª≠i ·∫£nh:", err);
            alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c v·ªõi server.");
          });
      }

      function renderDishList() {
        const container = document.getElementById("dish-items");
        const totalText = document.getElementById("total-price");
        container.innerHTML = "";
        let total = 0;

        allDishes.forEach((dish) => {
          container.innerHTML += `
            <div class="dish-item">
              <span>${dish.name}</span>
              <span>${dish.price.toLocaleString()}‚Ç´</span>
            </div>`;
          total += dish.price;
        });

        totalText.innerText = `T·ªïng ti·ªÅn: ${total.toLocaleString()}‚Ç´`;
      }

      function resetOrder() {
        allDishes = [];
        document.getElementById("dish-items").innerHTML = "";
        document.getElementById("total-price").innerText = "T·ªïng ti·ªÅn: 0‚Ç´";
        document.getElementById("captured-images").innerHTML = "";
      }
    </script>
  </body>
</html>
