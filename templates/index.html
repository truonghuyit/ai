<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nh·∫≠n Di·ªán M√≥n ƒÇn</title>

    <!-- Bootstrap & Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://aichat.ueh.edu.vn/keycloak/resources/q4rta/login/ueh/css/styles.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f4f7f9;
        font-family: "Segoe UI", sans-serif;
      }
      #loading-indicator {
  transition: all 0.3s ease;
}

      .container-custom {
        max-width: 1200px;
        margin: 40px auto;
        padding: 2rem;
        background: #fff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
      }
      .ueh-logo {
        height: 60px;
      }
      .camera-container {
        background-color: #e9ecef;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 360px;
      }
      video {
        border-radius: 10px;
        max-width: 100%;
        height: auto;
      }
      .captured-images img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin: 4px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .dish-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 1rem;
      }
      .total-price {
        font-weight: bold;
        font-size: 1.2rem;
        color: #0d6efd;
        text-align: right;
        margin-top: 10px;
      }
      .btn-reset {
        margin-top: 15px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div class="container-custom">
      <div class="text-center mb-4">
        <img
          src="https://aichat.ueh.edu.vn/keycloak/resources/q4rta/login/ueh/img/ueh-logo.png"
          class="ueh-logo"
          alt="UEH Logo"
        />
        <h3 class="mt-3">NH·∫¨N DI·ªÜN M√ìN - THANH TO√ÅN T·ª®C TH√å</h3>
      </div>
      <div class="row">
        <div class="col-md-5">
          <div class="camera-container">
            <video id="webcam" autoplay playsinline></video>
            <canvas id="captureCanvas" style="display: none"></canvas>
          </div>
          <div class="text-center mt-3">
            <button class="btn btn-primary mb-2" onclick="captureAndDetect()">
              üì∏ Ch·ª•p & Nh·∫≠n Di·ªán
            </button>
           

            <div class="form-text">Ho·∫∑c t·∫£i ·∫£nh t·ª´ m√°y:</div>
            <input
              type="file"
              class="form-control mt-2"
              accept="image/*"
              onchange="handleUpload(this)"
            />
          </div>
          <div class="form-text text-center mt-3">
            B·∫°n c√≥ th·ªÉ ch·ª•p ho·∫∑c upload nhi·ªÅu ·∫£nh ƒë·ªÉ ph√¢n t√≠ch m√≥n ƒÉn.
          </div>
          <div
            class="captured-images d-flex flex-wrap justify-content-center mt-3"
            id="captured-images"
          ></div>
        </div>
        <div class="col-md-7">
          <h5>üßæ Danh s√°ch m√≥n ƒÉn:</h5>
          <div class="text-center mt-3" id="loading-indicator" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="form-text">ƒêang nh·∫≠n di·ªán m√≥n ƒÉn...</div>
          </div>
          <div id="dish-items"></div>
          <div class="total-price" id="total-price">T·ªïng ti·ªÅn: 0‚Ç´</div>
          <div class="mt-4 text-center">
            <h6>üîÅ Qu√©t m√£ ƒë·ªÉ thanh to√°n</h6>
            <img
              id="qr-code-img"
              src="https://img.vietqr.io/image/ACB-34639877-compact.png?amount=0&addInfo=THANH+TOAN+BUA+AN"
              alt="QR Code"
              style="width: 180px; border: 1px solid #ccc; border-radius: 8px"
            />
            <div class="form-text">
              Chuy·ªÉn kho·∫£n ƒë√∫ng s·ªë ti·ªÅn v√† n·ªôi dung ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.
            </div>
          </div>
          <div class="text-end mt-4 d-flex justify-content-end gap-2">
            <button class="btn btn-success d-flex align-items-center" onclick="exportInvoiceToPDF()">
              <i class="fas fa-file-pdf me-2"></i> Xu·∫•t h√≥a ƒë∆°n PDF
            </button>
            <button class="btn btn-outline-danger d-flex align-items-center" onclick="resetOrder()">
              <i class="fas fa-trash-alt me-2"></i> Reset h√≥a ƒë∆°n
            </button>
          </div>
          
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const webcam = document.getElementById("webcam");
      const canvas = document.getElementById("captureCanvas");
      const context = canvas.getContext("2d");
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => (webcam.srcObject = stream))
        .catch((err) => console.error("Webcam kh√¥ng ho·∫°t ƒë·ªông:", err));
      let allDishes = [];

      function captureAndDetect() {
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        context.drawImage(webcam, 0, 0);
        const imageDataURL = canvas.toDataURL("image/jpeg");
        showPreviewImage(imageDataURL);
        sendImageToServer(imageDataURL);
      }

      function handleUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const base64Image = e.target.result;
          showPreviewImage(base64Image);
          sendImageToServer(base64Image);
        };
        reader.readAsDataURL(file);
      }

      function showPreviewImage(base64Image) {
        const imgEl = document.createElement("img");
        imgEl.src = base64Image;
        document.getElementById("captured-images").appendChild(imgEl);
      }

      function sendImageToServer(base64Image) {
        fetch("/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: base64Image }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              alert("L·ªói x·ª≠ l√Ω ·∫£nh: " + data.error);
              return;
            }
            if (data.dishes) {
              allDishes = allDishes.concat(data.dishes);
              renderDishList();
            } else {
              alert("Kh√¥ng ph√°t hi·ªán m√≥n ƒÉn n√†o.");
            }
          })
          .catch((err) => {
            console.error("L·ªói g·ª≠i ·∫£nh:", err);
            alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c v·ªõi server.");
          });
      }

      function renderDishList() {
        const container = document.getElementById("dish-items");
        const totalText = document.getElementById("total-price");
        const qrCodeImg = document.getElementById("qr-code-img");
        container.innerHTML = "";
        let total = 0;
        allDishes.forEach((dish) => {
          container.innerHTML += `<div class="dish-item"><span>${
            dish.name
          }</span><span>${dish.price.toLocaleString()}‚Ç´</span></div>`;
          total += dish.price;
        });
        totalText.innerText = `T·ªïng ti·ªÅn: ${total.toLocaleString()}‚Ç´`;
        if (qrCodeImg) {
          const base = "https://img.vietqr.io/image/ACB-34639877-compact.png";
          const qrParams = `?amount=${total}&addInfo=THANH+TOAN+BUA+AN`;
          qrCodeImg.src = base + qrParams;
        }
      }

      function resetOrder() {
        allDishes = [];
        document.getElementById("dish-items").innerHTML = "";
        document.getElementById("total-price").innerText = "T·ªïng ti·ªÅn: 0‚Ç´";
        document.getElementById("captured-images").innerHTML = "";
        document.getElementById("qr-code-img").src =
          "https://img.vietqr.io/image/ACB-34639877-compact.png?amount=0&addInfo=THANH+TOAN+BUA+AN";
      }

      async function exportInvoiceToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(16);
        doc.text("BILL", 70, y);
        y += 10;
        doc.setFontSize(10);
        const now = new Date();
        doc.text(`TIME: ${now.toLocaleString()}`, 14, y);
        y += 10;
        doc.setFont("Helvetica", "normal");
        doc.text("LIST:", 14, y);
        y += 8;
        let total = 0;
        allDishes.forEach((dish, i) => {
          doc.text(
            `${i + 1}. ${dish.name} - ${dish.price.toLocaleString()} VND`,
            20,
            y
          );
          y += 7;
          total += dish.price;
        });
        y += 10;
        doc.setFont("Helvetica", "bold");
        doc.setTextColor(0, 102, 204);
        doc.text(`TOTAL : ${total.toLocaleString()} VND`, 14, y);
        doc.save("hoa_don_mon_an.pdf");
      }
      function sendImageToServer(base64Image) {
  const loading = document.getElementById("loading-indicator");
  loading.style.display = "block"; // Hi·ªán spinner

  fetch("/predict", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ image: base64Image }),
  })
    .then((res) => res.json())
    .then((data) => {
      loading.style.display = "none"; // T·∫Øt spinner
      if (data.error) {
        alert("L·ªói x·ª≠ l√Ω ·∫£nh: " + data.error);
        return;
      }
      if (data.dishes) {
        allDishes = allDishes.concat(data.dishes);
        renderDishList();
      } else {
        alert("Kh√¥ng ph√°t hi·ªán m√≥n ƒÉn n√†o.");
      }
    })
    .catch((err) => {
      loading.style.display = "none"; // T·∫Øt spinner k·ªÉ c·∫£ l·ªói
      console.error("L·ªói g·ª≠i ·∫£nh:", err);
      alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c v·ªõi server.");
    });
}

    </script>
  </body>
</html>
